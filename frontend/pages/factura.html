<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Factura - Sistema de Agua LOTI</title>
    <link rel="stylesheet" href="../css/factura.css">
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üìÑ Sistema de Facturaci√≥n</h1>
            <div class="header-buttons">
                <!-- Bot√≥n de Pruebas de Desarrollo -->
                <button type="button" id="devButtonHeader" class="btn-dev-toggle hidden" onclick="openDevModal()">
                    üîß Desarrollo
                </button>
                <a href="mainPage.html" class="back-btn">‚Üê Volver al Inicio</a>
            </div>
        </header>

        <main class="main-content">
            <!-- Secci√≥n del Formulario de Facturaci√≥n -->
            <section class="invoice-form-section">
                <h2 class="section-title">Generaci√≥n de Factura</h2>
                
                <div id="message" class="message"></div>

                <form id="invoiceForm">
                    <!-- Selecci√≥n de Cliente con B√∫squeda y Filtros -->
                    <div class="form-group">
                        <label for="clienteSelect">Cliente *</label>
                        
                        <!-- Sistema de b√∫squeda y filtros -->
                        <div class="client-search-section">
                            <input type="text" id="searchClients" class="search-box" 
                                   placeholder="üîç Buscar por nombre, DPI, lote o contador...">
                            
                            <div class="filter-row">
                                <select id="projectFilter" title="Filtrar por proyecto" aria-label="Filtrar clientes por proyecto">
                                    <option value="">Todos los proyectos</option>
                                    <option value="san-miguel">San Miguel</option>
                                    <option value="santa-clara-1">Santa Clara Fase 1</option>
                                    <option value="santa-clara-2">Santa Clara Fase 2</option>
                                    <option value="cabanas-1">Caba√±as Fase 1</option>
                                    <option value="cabanas-2">Caba√±as Fase 2</option>
                                </select>
                                
                                <button type="button" id="clearFilters" class="clear-filters-btn" title="Limpiar filtros">
                                    üóëÔ∏è Limpiar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Select tradicional mejorado -->
                        <select id="clienteSelect" name="cliente" required>
                            <option value="">Cargando clientes...</option>
                        </select>
                        
                        <!-- Contador de clientes -->
                        <div class="client-counter">
                            <span id="clientCount">0 clientes encontrados</span>
                        </div>
                    </div>

                    <!-- Informaci√≥n del Cliente (se llena autom√°ticamente) -->
                    <div class="client-info hidden" id="clientInfo">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clienteNombre">Nombre Completo</label>
                                <input type="text" id="clienteNombre" readonly>
                            </div>
                            <div class="form-group">
                                <label for="clienteProyecto">Proyecto</label>
                                <input type="text" id="clienteProyecto" readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="clienteContador">No. Contador</label>
                                <input type="text" id="clienteContador" readonly>
                            </div>
                            <div class="form-group">
                                <label for="clienteLote">No. Lote</label>
                                <input type="text" id="clienteLote" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Datos de Consumo y Lectura -->
                    <div class="consumption-section hidden" id="consumptionSection">
                        <h3>üìä Datos de Consumo</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="lecturaAnterior">Lectura Anterior (Litros)</label>
                                <input type="number" id="lecturaAnterior" name="lecturaAnterior" 
                                       step="1" readonly>
                            </div>
                            <div class="form-group">
                                <label for="lecturaActual">Lectura Actual (Litros) *</label>
                                <input type="number" id="lecturaActual" name="lecturaActual" 
                                       step="1" required min="0">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="consumoCalculado">Consumo del Mes (Litros)</label>
                                <input type="number" id="consumoCalculado" readonly step="1">
                            </div>
                            <div class="form-group">
                                <label for="fechaLectura">Fecha de Lectura *</label>
                                <input type="date" id="fechaLectura" name="fechaLectura" required>
                            </div>
                        </div>

                        <!-- Per√≠odo de Facturaci√≥n -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="periodoInicio">Per√≠odo Desde *</label>
                                <input type="date" id="periodoInicio" name="periodoInicio" required>
                            </div>
                            <div class="form-group">
                                <label for="periodoFin">Per√≠odo Hasta *</label>
                                <input type="date" id="periodoFin" name="periodoFin" required>
                            </div>
                        </div>
                    </div>

                    <!-- C√°lculos de Tarifa (seg√∫n documento t√©cnico) -->
                    <div class="tariff-section hidden" id="tariffSection">
                        <h3>üí∞ C√°lculo de Tarifa</h3>
                        
                        <div class="tariff-breakdown">
                            <div class="tariff-item">
                                <label>Tarifa Base (hasta 30,000 litros):</label>
                                <span id="tarifaBase">Q 50.00</span>
                            </div>
                            
                            <div class="tariff-item hidden" id="excedentItem">
                                <label>Consumo Excedente:</label>
                                <span id="excedenteLitros">0 litros</span>
                            </div>
                            
                            <div class="tariff-item hidden" id="excedenteMontoItem">
                                <label>Costo Excedente (+ 7.5% recargo):</label>
                                <span id="excedenteMonto">Q 0.00</span>
                            </div>
                            
                            <div class="tariff-item">
                                <label>Subtotal:</label>
                                <span id="subtotal">Q 50.00</span>
                            </div>
                            
                            <div class="tariff-item total">
                                <label><strong>Total a Pagar (Redondeado):</strong></label>
                                <span id="montoTotal"><strong>Q 50.00</strong></span>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <div class="form-actions hidden" id="formActions">
                        <button type="submit" class="btn-primary">
                            üìÑ Generar Factura Interna
                        </button>
                        <button type="button" class="btn-secondary" onclick="resetForm()">
                            üîÑ Limpiar Formulario
                        </button>
                    </div>
                </form>

                <!-- Historial de Facturas del Cliente -->
                <div class="invoice-history hidden" id="invoiceHistory">
                    <h4>üìã Historial de Facturas</h4>
                    <div id="historyList">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </section>

            <!-- El bot√≥n de desarrollo ahora est√° en el header -->

            <!-- ========================================= -->
            <!-- SECCI√ìN DE ADMINISTRACI√ìN (OCULTA - SE MUESTRA EN MODAL) -->
            <!-- ========================================= -->
            <section class="admin-section hidden" id="adminSection">
                <div class="admin-header">
                    <h2 class="section-title">‚öôÔ∏è Panel de Administraci√≥n</h2>
                    <p class="admin-subtitle">Funciones especiales para pruebas y gesti√≥n de facturas</p>
                </div>

                <div class="admin-cards">
                    <!-- Card 1: Generar Hash de Contrase√±a -->
                    <div class="admin-card">
                        <div class="admin-card-icon">üîê</div>
                        <h3>Generar Contrase√±a</h3>
                        <p>Generar hash de contrase√±a administrativa (solo primera vez)</p>
                        <button type="button" class="btn-admin" onclick="openGenerateHashModal()">
                            Generar Hash
                        </button>
                    </div>

                    <!-- Card 2: Crear Factura con Fecha -->
                    <div class="admin-card">
                        <div class="admin-card-icon">üìÖ</div>
                        <h3>Factura Personalizada</h3>
                        <p>Crear factura con fechas personalizadas para pruebas</p>
                        <button type="button" class="btn-admin" onclick="openCustomInvoiceModal()">
                            Crear Factura
                        </button>
                    </div>

                    <!-- Card 3: Modificar Fecha de Vencimiento -->
                    <div class="admin-card">
                        <div class="admin-card-icon">‚úèÔ∏è</div>
                        <h3>Modificar Fecha</h3>
                        <p>Cambiar fecha de vencimiento de factura existente</p>
                        <button type="button" class="btn-admin" onclick="openModifyDateModal()">
                            Modificar Fecha
                        </button>
                    </div>

                    <!-- Card 4: Generar Lote de Prueba -->
                    <div class="admin-card">
                        <div class="admin-card-icon">üì¶</div>
                        <h3>Lote de Prueba</h3>
                        <p>Generar m√∫ltiples facturas con diferentes estados de mora</p>
                        <button type="button" class="btn-admin" onclick="openBatchModal()">
                            Generar Lote
                        </button>
                    </div>
                </div>

                <div class="admin-warning">
                    <strong>‚ö†Ô∏è Advertencia:</strong> Estas funciones est√°n dise√±adas para desarrollo y pruebas.
                    Las facturas creadas se marcan como "MODO PRUEBA".
                    <br>Estado actual: <span id="adminStatus">Verificando...</span>
                </div>
            </section>

            <!-- Secci√≥n de Vista Previa de Factura -->
            <section class="invoice-preview-section">
                <h2 class="section-title">Vista Previa de Factura</h2>
                
                <div class="invoice-preview" id="invoicePreview">
                    <div class="invoice-header">
                        <h2>üíß SISTEMA DE AGUA LOTI</h2>
                        <p>Factura Interna de Servicio de Agua</p>
                        <p class="fel-notice">‚ö†Ô∏è Documento interno - No v√°lido para efectos fiscales</p>
                        <p>üìç Retalhuleu, Guatemala</p>
                    </div>

                    <div class="invoice-details">
                        <div class="invoice-section">
                            <h4>Datos del Cliente</h4>
                            <p><strong>Nombre:</strong> <span id="preview-nombre">-</span></p>
                            <p><strong>Proyecto:</strong> <span id="preview-proyecto">-</span></p>
                            <p><strong>Contador:</strong> <span id="preview-contador">-</span></p>
                            <p><strong>Lote:</strong> <span id="preview-lote">-</span></p>
                        </div>
                        
                        <div class="invoice-section">
                            <h4>Datos de Facturaci√≥n</h4>
                            <p><strong>No. Factura:</strong> <span id="preview-factura">-</span></p>
                            <p><strong>Fecha Emisi√≥n:</strong> <span id="preview-fecha">-</span></p>
                            <p><strong>Per√≠odo:</strong> <span id="preview-periodo">-</span></p>
                            <p><strong>Fecha L√≠mite:</strong> <span id="preview-limite">-</span></p>
                        </div>
                    </div>

                    <!-- Detalles de Consumo -->
                    <div class="consumption-details">
                        <h4>üìä Detalles de Consumo</h4>
                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="invoice-items">
                                <tr>
                                    <td colspan="4" class="invoice-empty-cell">
                                        Complete el formulario para generar la vista previa
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Total y Observaciones -->
                    <div class="invoice-footer">
                        <div class="invoice-total" id="invoice-totals">
                            <!-- Los totales se llenar√°n din√°micamente -->
                        </div>
                        
                        <div class="invoice-notes">
                            <p><strong>Notas importantes:</strong></p>
                            <ul>
                                <li>Fecha l√≠mite de pago: 30 d√≠as despu√©s de emisi√≥n</li>
                                <li>Mora por pago tard√≠o: 7% mensual</li>
                                <li>Corte de servicio: despu√©s de 2 meses sin pago</li>
                                <li>Reconexi√≥n: Q 125.00 + facturas pendientes</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Acciones de Impresi√≥n -->
                <div class="print-section hidden" id="printSection">
                    <button type="button" class="btn-secondary" onclick="printInvoice()">
                        üñ®Ô∏è Imprimir Vista Previa
                    </button>
                    <button type="button" class="btn-info" onclick="downloadInvoicePDF()">
                        üìÅ Descargar PDF
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Confirmar Generaci√≥n de Factura</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">¬øEst√° seguro de generar esta factura?</p>
                <div id="confirmDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeConfirmModal()">Cancelar</button>
                <button type="button" class="btn-primary" onclick="confirmGenerateInvoice()">‚úÖ Confirmar</button>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODALES DE ADMINISTRACI√ìN -->
    <!-- ========================================= -->

    <!-- Modal: Generar Hash de Contrase√±a -->
    <div id="generateHashModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Generar Hash de Contrase√±a</h3>
                <span class="close-modal" onclick="closeGenerateHashModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Genera un hash seguro para la contrase√±a administrativa. Solo necesitas hacer esto una vez.</p>
                <div class="form-group">
                    <label for="adminPassword">Contrase√±a:</label>
                    <input type="password" id="adminPassword" placeholder="Ingresa una contrase√±a segura" required>
                </div>
                <div id="hashResult" class="hash-result hidden">
                    <p><strong>Hash generado:</strong></p>
                    <label for="hashOutput" class="visually-hidden">Hash generado para ADMIN_FECHA_PASSWORD</label>
                    <textarea id="hashOutput" title="Hash generado para ADMIN_FECHA_PASSWORD" placeholder="Hash generado (copiar al .env en ADMIN_FECHA_PASSWORD)" readonly rows="3" aria-label="Hash generado"></textarea>
                    <button type="button" class="btn-secondary" onclick="copyHash()">üìã Copiar Hash</button>
                    <p class="hash-instructions">
                        <strong>Instrucciones:</strong><br>
                        1. Copia el hash generado<br>
                        2. P√©galo en el archivo .env en la variable ADMIN_FECHA_PASSWORD<br>
                        3. Reinicia el servidor
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeGenerateHashModal()">Cancelar</button>
                <button type="button" class="btn-primary" onclick="generateHash()">‚úÖ Generar Hash</button>
            </div>
        </div>
    </div>

    <!-- Modal: Crear Factura con Fecha Personalizada -->
    <div id="customInvoiceModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>üìÖ Crear Factura con Fecha Personalizada</h3>
                <span class="close-modal" onclick="closeCustomInvoiceModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="customInvoiceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customClienteId">Cliente *</label>
                            <select id="customClienteId" required>
                                <option value="">Seleccionar cliente...</option>
                            </select>
                        </div>
                    </div>

                    <h4>Lecturas</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customLecturaAnterior">Lectura Anterior (Litros) *</label>
                            <input type="number" id="customLecturaAnterior" value="1000" required>
                        </div>
                        <div class="form-group">
                            <label for="customLecturaActual">Lectura Actual (Litros) *</label>
                            <input type="number" id="customLecturaActual" value="5000" required>
                        </div>
                    </div>

                    <h4>Fechas Personalizadas</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customFechaEmision">Fecha de Emisi√≥n *</label>
                            <input type="date" id="customFechaEmision" required>
                        </div>
                        <div class="form-group">
                            <label for="customFechaVencimiento">Fecha de Vencimiento *</label>
                            <input type="date" id="customFechaVencimiento" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="customPeriodoInicio">Per√≠odo Desde *</label>
                            <input type="date" id="customPeriodoInicio" required>
                        </div>
                        <div class="form-group">
                            <label for="customPeriodoFin">Per√≠odo Hasta *</label>
                            <input type="date" id="customPeriodoFin" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="customFechaLectura">Fecha de Lectura *</label>
                        <input type="date" id="customFechaLectura" required>
                    </div>

                    <div class="quick-dates">
                        <p><strong>Fechas R√°pidas:</strong></p>
                        <button type="button" class="btn-quick" onclick="setQuickDate('vencida30')">Vencida hace 30 d√≠as</button>
                        <button type="button" class="btn-quick" onclick="setQuickDate('vencida60')">Vencida hace 60 d√≠as</button>
                        <button type="button" class="btn-quick" onclick="setQuickDate('venceManana')">Vence ma√±ana</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomInvoiceModal()">Cancelar</button>
                <button type="button" class="btn-primary" onclick="createCustomInvoice()">‚úÖ Crear Factura</button>
            </div>
        </div>
    </div>

    <!-- Modal: Modificar Fecha de Vencimiento -->
    <div id="modifyDateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modificar Fecha de Vencimiento</h3>
                <span class="close-modal" onclick="closeModifyDateModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="modifyDateForm">
                    <div class="form-group">
                        <label for="modifyFacturaId">N√∫mero de Factura *</label>
                        <input type="text" id="modifyFacturaId" placeholder="FAC-202510-0001" required>
                        <small>Buscar factura por n√∫mero</small>
                    </div>

                    <div class="form-group">
                        <label for="modifyNuevaFecha">Nueva Fecha de Vencimiento *</label>
                        <input type="date" id="modifyNuevaFecha" required>
                    </div>

                    <div class="form-group">
                        <label for="modifyPassword">Contrase√±a Administrativa *</label>
                        <input type="password" id="modifyPassword" placeholder="Contrase√±a admin" required>
                    </div>

                    <div class="form-group">
                        <label for="modifyMotivo">Motivo del Cambio *</label>
                        <textarea id="modifyMotivo" rows="3" placeholder="Ej: Extensi√≥n por solicitud del cliente" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModifyDateModal()">Cancelar</button>
                <button type="button" class="btn-primary" onclick="modifyInvoiceDate()">‚úÖ Modificar Fecha</button>
            </div>
        </div>
    </div>

    <!-- Modal: Generar Lote de Prueba -->
    <div id="batchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì¶ Generar Lote de Facturas de Prueba</h3>
                <span class="close-modal" onclick="closeBatchModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Genera m√∫ltiples facturas con diferentes estados de mora para pruebas del sistema.</p>
                <form id="batchForm">
                    <div class="form-group">
                        <label for="batchClienteId">Cliente *</label>
                        <select id="batchClienteId" required>
                            <option value="">Seleccionar cliente...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="batchCantidad">Cantidad de Facturas *</label>
                        <input type="number" id="batchCantidad" value="5" min="1" max="10" required>
                        <small>Se generar√°n facturas con: sin mora, 10 d√≠as, 30 d√≠as, 60 d√≠as, 90 d√≠as de mora</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBatchModal()">Cancelar</button>
                <button type="button" class="btn-primary" onclick="generateBatch()">‚úÖ Generar Lote</button>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODAL: GESTIONAR FACTURAS DEL CLIENTE -->
    <!-- ========================================= -->
    <div id="manageInvoicesModal" class="modal">
        <div class="modal-content modal-xlarge">
            <div class="modal-header">
                <h3>üóëÔ∏è Gestionar Facturas del Cliente</h3>
                <span class="close-modal" onclick="closeManageInvoicesModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- B√∫squeda de Cliente -->
                <div class="manage-search-section">
                    <label for="manageClientSearch">Buscar Cliente:</label>
                    <input
                        type="text"
                        id="manageClientSearch"
                        class="search-box"
                        placeholder="üîç Buscar por nombre, DPI, No. de factura, contador..."
                        oninput="searchClientForManage()"
                    >
                </div>

                <!-- Resultados de B√∫squeda -->
                <div id="manageSearchResults" class="manage-search-results hidden">
                    <!-- Se llenar√° din√°micamente -->
                </div>

                <!-- Informaci√≥n del Cliente Seleccionado -->
                <div id="manageClientInfo" class="manage-client-info hidden">
                    <h4>Cliente Seleccionado:</h4>
                    <div id="manageClientDetails"></div>
                </div>

                <!-- Tabla de Facturas -->
                <div id="manageInvoicesTable" class="manage-invoices-table hidden">
                    <h4>Facturas del Cliente:</h4>
                    <div class="table-actions">
                        <label class="checkbox-label">
                            <input type="checkbox" id="selectAllInvoices" onchange="toggleSelectAll()">
                            <span>Seleccionar Todas</span>
                        </label>
                        <span id="selectedCount" class="selected-count">0 seleccionadas</span>
                    </div>

                    <div class="table-container">
                        <table id="invoicesTable">
                            <thead>
                                <tr>
                                    <th class="checkbox-column"></th>
                                    <th>No. Factura</th>
                                    <th>Fecha Emisi√≥n</th>
                                    <th>Fecha Vencimiento</th>
                                    <th>Estado</th>
                                    <th>Monto</th>
                                    <th>Mora</th>
                                    <th>Tipo</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTableBody">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>

                    <div class="manage-actions">
                        <button
                            type="button"
                            id="btnDeleteSelected"
                            class="btn-danger"
                            onclick="confirmDeleteInvoices()"
                            disabled
                        >
                            üóëÔ∏è Eliminar Seleccionadas (<span id="deleteCount">0</span>)
                        </button>
                    </div>
                </div>

                <!-- Mensaje cuando no hay resultados -->
                <div id="manageNoResults" class="manage-no-results hidden">
                    <p>üîç Busca un cliente para gestionar sus facturas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODAL: CONFIRMACI√ìN DE ELIMINACI√ìN (1ra) -->
    <!-- ========================================= -->
    <div id="deleteConfirmModal1" class="modal">
        <div class="modal-content">
            <div class="modal-header modal-header-warning">
                <h3>‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
                <span class="close-modal" onclick="closeDeleteConfirmModal1()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="warning-box">
                    <p><strong>¬øEst√° seguro que desea eliminar las facturas seleccionadas?</strong></p>
                    <div id="deleteConfirmDetails"></div>
                    <p class="warning-text">Esta acci√≥n no se puede deshacer.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeDeleteConfirmModal1()">Cancelar</button>
                <button type="button" class="btn-danger" onclick="showDeleteConfirmModal2()">S√≠, continuar</button>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODAL: CONFIRMACI√ìN DE ELIMINACI√ìN (2da) -->
    <!-- ========================================= -->
    <div id="deleteConfirmModal2" class="modal">
        <div class="modal-content">
            <div class="modal-header modal-header-danger">
                <h3>üîê Confirmaci√≥n Final</h3>
                <span class="close-modal" onclick="closeDeleteConfirmModal2()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="danger-box">
                    <p><strong>CONFIRMACI√ìN FINAL DE ELIMINACI√ìN</strong></p>
                    <p>Est√° a punto de eliminar permanentemente <strong><span id="finalDeleteCount">0</span> facturas</strong>.</p>

                    <div class="form-group">
                        <label for="deletePassword">Contrase√±a Administrativa *</label>
                        <input
                            type="password"
                            id="deletePassword"
                            placeholder="Ingrese la contrase√±a administrativa"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="deleteMotivo">Motivo de la Eliminaci√≥n *</label>
                        <textarea
                            id="deleteMotivo"
                            rows="3"
                            placeholder="Ej: Facturas de prueba, datos err√≥neos, etc."
                            required
                        ></textarea>
                    </div>

                    <p class="danger-text">‚ö†Ô∏è Esta acci√≥n quedar√° registrada en el sistema de auditor√≠a.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeDeleteConfirmModal2()">Cancelar</button>
                <button type="button" class="btn-danger" onclick="executeDeleteInvoices()">‚úÖ Confirmar Eliminaci√≥n</button>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODAL: GESTIONAR PAGOS DEL CLIENTE -->
    <!-- ========================================= -->
    <div id="managePaymentsModal" class="modal">
        <div class="modal-content modal-xlarge">
            <div class="modal-header">
                <h3>üí∞ Gestionar Pagos del Cliente</h3>
                <span class="close-modal" onclick="closeManagePaymentsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="manage-search-section">
                    <label for="searchClientForPayments">Buscar Cliente:</label>
                    <input
                        type="text"
                        id="searchClientForPayments"
                        placeholder="Buscar por nombre, DPI, contador o n√∫mero de factura..."
                        oninput="searchClientForPayments()"
                    >
                    <div id="paymentSearchResults" class="search-results"></div>
                </div>

                <div id="paymentClientInfo" class="client-info-manage hidden">
                    <h4>Cliente Seleccionado:</h4>
                    <p><strong>Nombre:</strong> <span id="paymentClientName">-</span></p>
                    <p><strong>DPI:</strong> <span id="paymentClientDPI">-</span></p>
                    <p><strong>Contador:</strong> <span id="paymentClientCounter">-</span></p>
                </div>

                <div id="paymentsTableSection" class="hidden">
                    <div class="table-header-section">
                        <h4>Pagos del Cliente</h4>
                        <div class="selection-info">
                            <label class="checkbox-label">
                                <input type="checkbox" id="selectAllPayments" onchange="toggleAllPayments()">
                                Seleccionar Todos
                            </label>
                            <span id="selectedPaymentsCount" class="count-badge">0 seleccionados</span>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="paymentsTable" class="manage-table">
                            <thead>
                                <tr>
                                    <th width="50px">
                                        <input type="checkbox" disabled title="Use 'Seleccionar Todos'">
                                    </th>
                                    <th>N√∫mero Pago</th>
                                    <th>Factura</th>
                                    <th>Fecha Pago</th>
                                    <th>Monto</th>
                                    <th>M√©todo</th>
                                    <th>Estado FEL</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody">
                                <!-- Se llena din√°micamente -->
                            </tbody>
                        </table>
                    </div>

                    <div class="warning-box">
                        <p><strong>‚ö†Ô∏è Advertencia:</strong> Solo se pueden eliminar pagos NO certificados por FEL.</p>
                        <p>Los pagos certificados aparecer√°n deshabilitados en la lista.</p>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeManagePaymentsModal()">Cancelar</button>
                        <button type="button" class="btn-danger" id="btnDeletePayments" onclick="confirmDeletePayments()" disabled>
                            üóëÔ∏è Eliminar Seleccionados
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODAL: CONFIRMACI√ìN ELIMINAR PAGOS (1ra) -->
    <!-- ========================================= -->
    <div id="deletePaymentsConfirmModal1" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Confirmar Eliminaci√≥n de Pagos</h3>
                <span class="close-modal" onclick="closeDeletePaymentsConfirmModal1()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="warning-box">
                    <p><strong>Est√° a punto de eliminar <span id="paymentsDeleteCount1">0</span> pagos.</strong></p>
                    <p>Cliente: <strong><span id="paymentsClientName1">-</span></strong></p>
                    <br>
                    <p><strong>Consecuencias:</strong></p>
                    <ul>
                        <li>Los pagos ser√°n eliminados permanentemente</li>
                        <li>Las facturas asociadas volver√°n a estado "pendiente"</li>
                        <li>Esta acci√≥n quedar√° registrada en auditor√≠a</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeDeletePaymentsConfirmModal1()">Cancelar</button>
                <button type="button" class="btn-danger" onclick="openDeletePaymentsConfirmModal2()">Continuar</button>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODAL: CONFIRMACI√ìN ELIMINAR PAGOS (2da) -->
    <!-- ========================================= -->
    <div id="deletePaymentsConfirmModal2" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Confirmaci√≥n Final - Pagos</h3>
                <span class="close-modal" onclick="closeDeletePaymentsConfirmModal2()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="danger-box">
                    <p><strong>CONFIRMACI√ìN FINAL DE ELIMINACI√ìN</strong></p>
                    <p>Est√° a punto de eliminar permanentemente <strong><span id="finalPaymentsDeleteCount">0</span> pagos</strong>.</p>

                    <div class="form-group">
                        <label for="deletePaymentsPassword">Contrase√±a Administrativa *</label>
                        <input
                            type="password"
                            id="deletePaymentsPassword"
                            placeholder="Ingrese la contrase√±a administrativa"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="deletePaymentsMotivo">Motivo de la Eliminaci√≥n *</label>
                        <textarea
                            id="deletePaymentsMotivo"
                            rows="3"
                            placeholder="Ej: Pagos duplicados, error en registro, etc."
                            required
                        ></textarea>
                    </div>

                    <p class="danger-text">‚ö†Ô∏è Esta acci√≥n quedar√° registrada en el sistema de auditor√≠a.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeDeletePaymentsConfirmModal2()">Cancelar</button>
                <button type="button" class="btn-danger" onclick="executeDeletePayments()">‚úÖ Confirmar Eliminaci√≥n</button>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODAL: ANULAR FACTURA CERTIFICADA -->
    <!-- ========================================= -->
    <div id="cancelCertifiedModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Anular Factura Certificada FEL</h3>
                <span class="close-modal" onclick="closeCancelCertifiedModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="manage-search-section">
                    <label for="searchCertifiedInvoice">Buscar Factura Certificada:</label>
                    <input
                        type="text"
                        id="searchCertifiedInvoice"
                        placeholder="Buscar por n√∫mero de factura, UUID o nombre de cliente..."
                        oninput="searchCertifiedInvoice()"
                    >
                    <div id="certifiedSearchResults" class="search-results"></div>
                </div>

                <div id="certifiedInvoiceInfo" class="client-info-manage hidden">
                    <h4>Factura Seleccionada:</h4>
                    <div class="invoice-detail-grid">
                        <p><strong>N√∫mero:</strong> <span id="certifiedInvoiceNumber">-</span></p>
                        <p><strong>UUID:</strong> <span id="certifiedInvoiceUUID">-</span></p>
                        <p><strong>Cliente:</strong> <span id="certifiedInvoiceClient">-</span></p>
                        <p><strong>Monto:</strong> <span id="certifiedInvoiceAmount">-</span></p>
                        <p><strong>Fecha Cert.:</strong> <span id="certifiedInvoiceDate">-</span></p>
                        <p><strong>Estado:</strong> <span id="certifiedInvoiceStatus">-</span></p>
                    </div>
                </div>

                <div id="cancelCertifiedForm" class="hidden">
                    <div class="warning-box">
                        <p><strong>‚ö†Ô∏è IMPORTANTE:</strong></p>
                        <ul>
                            <li>Esta factura est√° certificada ante SAT</li>
                            <li>Al anular, se debe generar Nota de Cr√©dito (NCRE) en Infile</li>
                            <li>La factura NO se elimina, solo se marca como anulada</li>
                            <li>El proceso es irreversible</li>
                        </ul>
                    </div>

                    <div class="form-group">
                        <label for="cancelPassword">Contrase√±a Administrativa *</label>
                        <input
                            type="password"
                            id="cancelPassword"
                            placeholder="Ingrese la contrase√±a administrativa"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="cancelMotivo">Motivo de la Anulaci√≥n *</label>
                        <textarea
                            id="cancelMotivo"
                            rows="4"
                            placeholder="Describa detalladamente el motivo de la anulaci√≥n (requerido por SAT)..."
                            required
                        ></textarea>
                    </div>

                    <div class="info-box">
                        <p><strong>üìù Pr√≥ximo paso:</strong> Despu√©s de anular aqu√≠, debe generar la Nota de Cr√©dito en el sistema de Infile.</p>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeCancelCertifiedModal()">Cancelar</button>
                        <button type="button" class="btn-warning" onclick="executeCancelCertified()">‚ö†Ô∏è Anular Factura</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODAL: PRUEBAS DE DESARROLLO -->
    <!-- ========================================= -->
    <div id="devModal" class="modal">
        <div class="modal-content modal-large modal-dev">
            <div class="modal-header">
                <h3>üîß Pruebas de Desarrollo</h3>
                <span class="close-modal" onclick="closeDevModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p class="dev-modal-subtitle">Funciones especiales para pruebas y gesti√≥n de facturas</p>

                <div class="admin-cards">
                    <!-- Card 1: Generar Hash de Contrase√±a -->
                    <div class="admin-card">
                        <div class="admin-card-icon">üîê</div>
                        <h3>Generar Contrase√±a</h3>
                        <p>Generar hash de contrase√±a administrativa (solo primera vez)</p>
                        <button type="button" class="btn-admin" onclick="openGenerateHashModal(); closeDevModal();">
                            Generar Hash
                        </button>
                    </div>

                    <!-- Card 2: Crear Factura con Fecha -->
                    <div class="admin-card">
                        <div class="admin-card-icon">üìÖ</div>
                        <h3>Factura Personalizada</h3>
                        <p>Crear factura con fechas personalizadas para pruebas</p>
                        <button type="button" class="btn-admin" onclick="openCustomInvoiceModal(); closeDevModal();">
                            Crear Factura
                        </button>
                    </div>

                    <!-- Card 3: Modificar Fecha de Vencimiento -->
                    <div class="admin-card">
                        <div class="admin-card-icon">‚úèÔ∏è</div>
                        <h3>Modificar Fecha</h3>
                        <p>Cambiar fecha de vencimiento de factura existente</p>
                        <button type="button" class="btn-admin" onclick="openModifyDateModal(); closeDevModal();">
                            Modificar Fecha
                        </button>
                    </div>

                    <!-- Card 4: Generar Lote de Prueba -->
                    <div class="admin-card">
                        <div class="admin-card-icon">üì¶</div>
                        <h3>Lote de Prueba</h3>
                        <p>Generar m√∫ltiples facturas con diferentes estados de mora</p>
                        <button type="button" class="btn-admin" onclick="openBatchModal(); closeDevModal();">
                            Generar Lote
                        </button>
                    </div>

                    <!-- Card 5: Gestionar Facturas del Cliente -->
                    <div class="admin-card">
                        <div class="admin-card-icon">üóëÔ∏è</div>
                        <h3>Gestionar Facturas</h3>
                        <p>Buscar cliente y eliminar facturas NO certificadas</p>
                        <button type="button" class="btn-admin btn-admin-danger" onclick="openManageInvoicesModal(); closeDevModal();">
                            Gestionar Facturas
                        </button>
                    </div>

                    <!-- Card 6: Gestionar Pagos del Cliente -->
                    <div class="admin-card">
                        <div class="admin-card-icon">üí∞</div>
                        <h3>Gestionar Pagos</h3>
                        <p>Buscar cliente y eliminar pagos NO certificados</p>
                        <button type="button" class="btn-admin btn-admin-danger" onclick="openManagePaymentsModal(); closeDevModal();">
                            Gestionar Pagos
                        </button>
                    </div>

                    <!-- Card 7: Anular Factura Certificada -->
                    <div class="admin-card">
                        <div class="admin-card-icon">‚ö†Ô∏è</div>
                        <h3>Anular Factura FEL</h3>
                        <p>Anular factura YA certificada (crea NCRE en Infile)</p>
                        <button type="button" class="btn-admin btn-admin-warning" onclick="openCancelCertifiedModal(); closeDevModal();">
                            Anular Certificada
                        </button>
                    </div>
                </div>

                <div class="admin-warning">
                    <strong>‚ö†Ô∏è Advertencia:</strong> Estas funciones est√°n dise√±adas para desarrollo y pruebas.
                    Las facturas creadas se marcan como "MODO PRUEBA".
                    <br>Estado actual: <span id="adminStatusModal">Verificando...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/auth.js"></script>
    <script src="../js/pageProtection.js"></script>
    <script src="../js/factura.js"></script>
    <script src="../js/factura.admin.js"></script>
</body>
</html>