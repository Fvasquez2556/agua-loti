<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Factura - Sistema de Agua LOTI</title>
    <link rel="stylesheet" href="../css/factura.css">
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üìÑ Sistema de Facturaci√≥n</h1>
            <a href="mainPage.html" class="back-btn">‚Üê Volver al Inicio</a>
        </header>

        <main class="main-content">
            <!-- Secci√≥n del Formulario de Facturaci√≥n -->
            <section class="invoice-form-section">
                <h2 class="section-title">Generaci√≥n de Factura</h2>
                
                <div id="message" class="message"></div>

                <form id="invoiceForm">
                    <!-- Selecci√≥n de Cliente con B√∫squeda y Filtros -->
                    <div class="form-group">
                        <label for="clienteSelect">Cliente *</label>
                        
                        <!-- Sistema de b√∫squeda y filtros -->
                        <div class="client-search-section">
                            <input type="text" id="searchClients" class="search-box" 
                                   placeholder="üîç Buscar por nombre, DPI, lote o contador...">
                            
                            <div class="filter-row">
                                <select id="projectFilter" title="Filtrar por proyecto" aria-label="Filtrar clientes por proyecto">
                                    <option value="">Todos los proyectos</option>
                                    <option value="san-miguel">San Miguel</option>
                                    <option value="santa-clara-1">Santa Clara Fase 1</option>
                                    <option value="santa-clara-2">Santa Clara Fase 2</option>
                                    <option value="cabanas-1">Caba√±as Fase 1</option>
                                    <option value="cabanas-2">Caba√±as Fase 2</option>
                                </select>
                                
                                <button type="button" id="clearFilters" class="clear-filters-btn" title="Limpiar filtros">
                                    üóëÔ∏è Limpiar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Select tradicional mejorado -->
                        <select id="clienteSelect" name="cliente" required>
                            <option value="">Cargando clientes...</option>
                        </select>
                        
                        <!-- Contador de clientes -->
                        <div class="client-counter">
                            <span id="clientCount">0 clientes encontrados</span>
                        </div>
                    </div>

                    <!-- Informaci√≥n del Cliente (se llena autom√°ticamente) -->
                    <div class="client-info hidden" id="clientInfo">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clienteNombre">Nombre Completo</label>
                                <input type="text" id="clienteNombre" readonly>
                            </div>
                            <div class="form-group">
                                <label for="clienteProyecto">Proyecto</label>
                                <input type="text" id="clienteProyecto" readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="clienteContador">No. Contador</label>
                                <input type="text" id="clienteContador" readonly>
                            </div>
                            <div class="form-group">
                                <label for="clienteLote">No. Lote</label>
                                <input type="text" id="clienteLote" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Datos de Consumo y Lectura -->
                    <div class="consumption-section hidden" id="consumptionSection">
                        <h3>üìä Datos de Consumo</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="lecturaAnterior">Lectura Anterior (Litros)</label>
                                <input type="number" id="lecturaAnterior" name="lecturaAnterior" 
                                       step="1" readonly>
                            </div>
                            <div class="form-group">
                                <label for="lecturaActual">Lectura Actual (Litros) *</label>
                                <input type="number" id="lecturaActual" name="lecturaActual" 
                                       step="1" required min="0">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="consumoCalculado">Consumo del Mes (Litros)</label>
                                <input type="number" id="consumoCalculado" readonly step="1">
                            </div>
                            <div class="form-group">
                                <label for="fechaLectura">Fecha de Lectura *</label>
                                <input type="date" id="fechaLectura" name="fechaLectura" required>
                            </div>
                        </div>

                        <!-- Per√≠odo de Facturaci√≥n -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="periodoInicio">Per√≠odo Desde *</label>
                                <input type="date" id="periodoInicio" name="periodoInicio" required>
                            </div>
                            <div class="form-group">
                                <label for="periodoFin">Per√≠odo Hasta *</label>
                                <input type="date" id="periodoFin" name="periodoFin" required>
                            </div>
                        </div>
                    </div>

                    <!-- C√°lculos de Tarifa (seg√∫n documento t√©cnico) -->
                    <div class="tariff-section hidden" id="tariffSection">
                        <h3>üí∞ C√°lculo de Tarifa</h3>
                        
                        <div class="tariff-breakdown">
                            <div class="tariff-item">
                                <label>Tarifa Base (hasta 30,000 litros):</label>
                                <span id="tarifaBase">Q 50.00</span>
                            </div>
                            
                            <div class="tariff-item hidden" id="excedentItem">
                                <label>Consumo Excedente:</label>
                                <span id="excedenteLitros">0 litros</span>
                            </div>
                            
                            <div class="tariff-item hidden" id="excedenteMontoItem">
                                <label>Costo Excedente (+ 7.5% recargo):</label>
                                <span id="excedenteMonto">Q 0.00</span>
                            </div>
                            
                            <div class="tariff-item">
                                <label>Subtotal:</label>
                                <span id="subtotal">Q 50.00</span>
                            </div>
                            
                            <div class="tariff-item total">
                                <label><strong>Total a Pagar (Redondeado):</strong></label>
                                <span id="montoTotal"><strong>Q 50.00</strong></span>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <div class="form-actions hidden" id="formActions">
                        <button type="submit" class="btn-primary">
                            üìÑ Generar Factura Interna
                        </button>
                        <button type="button" class="btn-secondary" onclick="resetForm()">
                            üîÑ Limpiar Formulario
                        </button>
                    </div>
                </form>

                <!-- Historial de Facturas del Cliente -->
                <div class="invoice-history hidden" id="invoiceHistory">
                    <h4>üìã Historial de Facturas</h4>
                    <div id="historyList">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </section>

            <!-- ========================================= -->
            <!-- SECCI√ìN DE ADMINISTRACI√ìN -->
            <!-- ========================================= -->
            <section class="admin-section" id="adminSection">
                <div class="admin-header">
                    <h2 class="section-title">‚öôÔ∏è Panel de Administraci√≥n</h2>
                    <p class="admin-subtitle">Funciones especiales para pruebas y gesti√≥n de facturas</p>
                </div>

                <div class="admin-cards">
                    <!-- Card 1: Generar Hash de Contrase√±a -->
                    <div class="admin-card">
                        <div class="admin-card-icon">üîê</div>
                        <h3>Generar Contrase√±a</h3>
                        <p>Generar hash de contrase√±a administrativa (solo primera vez)</p>
                        <button type="button" class="btn-admin" onclick="openGenerateHashModal()">
                            Generar Hash
                        </button>
                    </div>

                    <!-- Card 2: Crear Factura con Fecha -->
                    <div class="admin-card">
                        <div class="admin-card-icon">üìÖ</div>
                        <h3>Factura Personalizada</h3>
                        <p>Crear factura con fechas personalizadas para pruebas</p>
                        <button type="button" class="btn-admin" onclick="openCustomInvoiceModal()">
                            Crear Factura
                        </button>
                    </div>

                    <!-- Card 3: Modificar Fecha de Vencimiento -->
                    <div class="admin-card">
                        <div class="admin-card-icon">‚úèÔ∏è</div>
                        <h3>Modificar Fecha</h3>
                        <p>Cambiar fecha de vencimiento de factura existente</p>
                        <button type="button" class="btn-admin" onclick="openModifyDateModal()">
                            Modificar Fecha
                        </button>
                    </div>

                    <!-- Card 4: Generar Lote de Prueba -->
                    <div class="admin-card">
                        <div class="admin-card-icon">üì¶</div>
                        <h3>Lote de Prueba</h3>
                        <p>Generar m√∫ltiples facturas con diferentes estados de mora</p>
                        <button type="button" class="btn-admin" onclick="openBatchModal()">
                            Generar Lote
                        </button>
                    </div>
                </div>

                <div class="admin-warning">
                    <strong>‚ö†Ô∏è Advertencia:</strong> Estas funciones est√°n dise√±adas para desarrollo y pruebas.
                    Las facturas creadas se marcan como "MODO PRUEBA".
                    <br>Estado actual: <span id="adminStatus">Verificando...</span>
                </div>
            </section>

            <!-- Secci√≥n de Vista Previa de Factura -->
            <section class="invoice-preview-section">
                <h2 class="section-title">Vista Previa de Factura</h2>
                
                <div class="invoice-preview" id="invoicePreview">
                    <div class="invoice-header">
                        <h2>üíß SISTEMA DE AGUA LOTI</h2>
                        <p>Factura Interna de Servicio de Agua</p>
                        <p class="fel-notice">‚ö†Ô∏è Documento interno - No v√°lido para efectos fiscales</p>
                        <p>üìç Retalhuleu, Guatemala</p>
                    </div>

                    <div class="invoice-details">
                        <div class="invoice-section">
                            <h4>Datos del Cliente</h4>
                            <p><strong>Nombre:</strong> <span id="preview-nombre">-</span></p>
                            <p><strong>Proyecto:</strong> <span id="preview-proyecto">-</span></p>
                            <p><strong>Contador:</strong> <span id="preview-contador">-</span></p>
                            <p><strong>Lote:</strong> <span id="preview-lote">-</span></p>
                        </div>
                        
                        <div class="invoice-section">
                            <h4>Datos de Facturaci√≥n</h4>
                            <p><strong>No. Factura:</strong> <span id="preview-factura">-</span></p>
                            <p><strong>Fecha Emisi√≥n:</strong> <span id="preview-fecha">-</span></p>
                            <p><strong>Per√≠odo:</strong> <span id="preview-periodo">-</span></p>
                            <p><strong>Fecha L√≠mite:</strong> <span id="preview-limite">-</span></p>
                        </div>
                    </div>

                    <!-- Detalles de Consumo -->
                    <div class="consumption-details">
                        <h4>üìä Detalles de Consumo</h4>
                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="invoice-items">
                                <tr>
                                    <td colspan="4" class="invoice-empty-cell">
                                        Complete el formulario para generar la vista previa
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Total y Observaciones -->
                    <div class="invoice-footer">
                        <div class="invoice-total" id="invoice-totals">
                            <!-- Los totales se llenar√°n din√°micamente -->
                        </div>
                        
                        <div class="invoice-notes">
                            <p><strong>Notas importantes:</strong></p>
                            <ul>
                                <li>Fecha l√≠mite de pago: 30 d√≠as despu√©s de emisi√≥n</li>
                                <li>Mora por pago tard√≠o: 7% mensual</li>
                                <li>Corte de servicio: despu√©s de 2 meses sin pago</li>
                                <li>Reconexi√≥n: Q 125.00 + facturas pendientes</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Acciones de Impresi√≥n -->
                <div class="print-section hidden" id="printSection">
                    <button type="button" class="btn-secondary" onclick="printInvoice()">
                        üñ®Ô∏è Imprimir Vista Previa
                    </button>
                    <button type="button" class="btn-info" onclick="downloadInvoicePDF()">
                        üìÅ Descargar PDF
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Confirmar Generaci√≥n de Factura</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">¬øEst√° seguro de generar esta factura?</p>
                <div id="confirmDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeConfirmModal()">Cancelar</button>
                <button type="button" class="btn-primary" onclick="confirmGenerateInvoice()">‚úÖ Confirmar</button>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODALES DE ADMINISTRACI√ìN -->
    <!-- ========================================= -->

    <!-- Modal: Generar Hash de Contrase√±a -->
    <div id="generateHashModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Generar Hash de Contrase√±a</h3>
                <span class="close-modal" onclick="closeGenerateHashModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Genera un hash seguro para la contrase√±a administrativa. Solo necesitas hacer esto una vez.</p>
                <div class="form-group">
                    <label for="adminPassword">Contrase√±a:</label>
                    <input type="password" id="adminPassword" placeholder="Ingresa una contrase√±a segura" required>
                </div>
                <div id="hashResult" class="hash-result hidden">
                    <p><strong>Hash generado:</strong></p>
                    <textarea id="hashOutput" readonly rows="3"></textarea>
                    <button type="button" class="btn-secondary" onclick="copyHash()">üìã Copiar Hash</button>
                    <p class="hash-instructions">
                        <strong>Instrucciones:</strong><br>
                        1. Copia el hash generado<br>
                        2. P√©galo en el archivo .env en la variable ADMIN_FECHA_PASSWORD<br>
                        3. Reinicia el servidor
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeGenerateHashModal()">Cancelar</button>
                <button type="button" class="btn-primary" onclick="generateHash()">‚úÖ Generar Hash</button>
            </div>
        </div>
    </div>

    <!-- Modal: Crear Factura con Fecha Personalizada -->
    <div id="customInvoiceModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>üìÖ Crear Factura con Fecha Personalizada</h3>
                <span class="close-modal" onclick="closeCustomInvoiceModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="customInvoiceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customClienteId">Cliente *</label>
                            <select id="customClienteId" required>
                                <option value="">Seleccionar cliente...</option>
                            </select>
                        </div>
                    </div>

                    <h4>Lecturas</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customLecturaAnterior">Lectura Anterior (Litros) *</label>
                            <input type="number" id="customLecturaAnterior" value="1000" required>
                        </div>
                        <div class="form-group">
                            <label for="customLecturaActual">Lectura Actual (Litros) *</label>
                            <input type="number" id="customLecturaActual" value="5000" required>
                        </div>
                    </div>

                    <h4>Fechas Personalizadas</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customFechaEmision">Fecha de Emisi√≥n *</label>
                            <input type="date" id="customFechaEmision" required>
                        </div>
                        <div class="form-group">
                            <label for="customFechaVencimiento">Fecha de Vencimiento *</label>
                            <input type="date" id="customFechaVencimiento" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="customPeriodoInicio">Per√≠odo Desde *</label>
                            <input type="date" id="customPeriodoInicio" required>
                        </div>
                        <div class="form-group">
                            <label for="customPeriodoFin">Per√≠odo Hasta *</label>
                            <input type="date" id="customPeriodoFin" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="customFechaLectura">Fecha de Lectura *</label>
                        <input type="date" id="customFechaLectura" required>
                    </div>

                    <div class="quick-dates">
                        <p><strong>Fechas R√°pidas:</strong></p>
                        <button type="button" class="btn-quick" onclick="setQuickDate('vencida30')">Vencida hace 30 d√≠as</button>
                        <button type="button" class="btn-quick" onclick="setQuickDate('vencida60')">Vencida hace 60 d√≠as</button>
                        <button type="button" class="btn-quick" onclick="setQuickDate('venceManana')">Vence ma√±ana</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomInvoiceModal()">Cancelar</button>
                <button type="button" class="btn-primary" onclick="createCustomInvoice()">‚úÖ Crear Factura</button>
            </div>
        </div>
    </div>

    <!-- Modal: Modificar Fecha de Vencimiento -->
    <div id="modifyDateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modificar Fecha de Vencimiento</h3>
                <span class="close-modal" onclick="closeModifyDateModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="modifyDateForm">
                    <div class="form-group">
                        <label for="modifyFacturaId">N√∫mero de Factura *</label>
                        <input type="text" id="modifyFacturaId" placeholder="FAC-202510-0001" required>
                        <small>Buscar factura por n√∫mero</small>
                    </div>

                    <div class="form-group">
                        <label for="modifyNuevaFecha">Nueva Fecha de Vencimiento *</label>
                        <input type="date" id="modifyNuevaFecha" required>
                    </div>

                    <div class="form-group">
                        <label for="modifyPassword">Contrase√±a Administrativa *</label>
                        <input type="password" id="modifyPassword" placeholder="Contrase√±a admin" required>
                    </div>

                    <div class="form-group">
                        <label for="modifyMotivo">Motivo del Cambio *</label>
                        <textarea id="modifyMotivo" rows="3" placeholder="Ej: Extensi√≥n por solicitud del cliente" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModifyDateModal()">Cancelar</button>
                <button type="button" class="btn-primary" onclick="modifyInvoiceDate()">‚úÖ Modificar Fecha</button>
            </div>
        </div>
    </div>

    <!-- Modal: Generar Lote de Prueba -->
    <div id="batchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì¶ Generar Lote de Facturas de Prueba</h3>
                <span class="close-modal" onclick="closeBatchModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Genera m√∫ltiples facturas con diferentes estados de mora para pruebas del sistema.</p>
                <form id="batchForm">
                    <div class="form-group">
                        <label for="batchClienteId">Cliente *</label>
                        <select id="batchClienteId" required>
                            <option value="">Seleccionar cliente...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="batchCantidad">Cantidad de Facturas *</label>
                        <input type="number" id="batchCantidad" value="5" min="1" max="10" required>
                        <small>Se generar√°n facturas con: sin mora, 10 d√≠as, 30 d√≠as, 60 d√≠as, 90 d√≠as de mora</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBatchModal()">Cancelar</button>
                <button type="button" class="btn-primary" onclick="generateBatch()">‚úÖ Generar Lote</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/auth.js"></script>
    <script src="../js/pageProtection.js"></script>
    <script src="../js/factura.js"></script>
    <script src="../js/factura.admin.js"></script>
</body>
</html>