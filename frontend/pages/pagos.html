<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Pagos - Sistema de Agua LOTI</title>
    <link rel="stylesheet" href="../css/pagos.css">
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üí∞ Sistema de Control de Pagos</h1>
            <div class="header-buttons">
                <button type="button" id="btnManageInvoices" class="btn-manage-invoices hidden" onclick="openManageInvoicesModal()">
                    üóëÔ∏è Gestionar Facturas
                </button>
                <a href="mainPage.html" class="back-btn">‚Üê Volver al Inicio</a>
            </div>
        </header>

        <main class="main-content">
            <!-- Secci√≥n de Registro de Pagos -->
            <section class="payment-form-section">
                <h2 class="section-title">Registrar Pago</h2>
                
                <div id="message" class="message"></div>

                <form id="paymentForm">
                    <!-- Selecci√≥n de Cliente -->
                    <div class="form-group">
                        <label for="clienteSelect">Cliente *</label>
                        <select id="clienteSelect" name="cliente" required>
                            <option value="">Cargando clientes...</option>
                        </select>
                    </div>

                    <!-- Facturas pendientes del cliente seleccionado -->
                    <div class="form-group hidden" id="pendingInvoicesSection">
                        <label for="facturaSelect">Facturas Pendientes *</label>
                        <select id="facturaSelect" name="factura" required>
                            <option value="">Seleccione una factura</option>
                        </select>
                        <small class="form-help">Se muestran facturas pendientes y vencidas</small>
                    </div>

                    <!-- Informaci√≥n de la factura seleccionada -->
                    <div class="invoice-info hidden" id="invoiceInfo">
                        <h4>üìã Informaci√≥n de la Factura</h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>No. Factura:</label>
                                <span id="facturaNumero">-</span>
                            </div>
                            <div class="info-item">
                                <label>Fecha Emisi√≥n:</label>
                                <span id="facturaFecha">-</span>
                            </div>
                            <div class="info-item">
                                <label>Monto Original:</label>
                                <span id="montoOriginal">Q 0.00</span>
                            </div>
                            <div class="info-item">
                                <label>Mora Acumulada:</label>
                                <span id="moraAcumulada">Q 0.00</span>
                            </div>
                            <div class="info-item total">
                                <label><strong>Total a Pagar:</strong></label>
                                <span id="totalAPagar"><strong>Q 0.00</strong></span>
                            </div>
                            <div class="info-item">
                                <label>Estado:</label>
                                <span id="estadoFactura" class="status-badge">-</span>
                            </div>
                        </div>
                        
                        <!-- Alerta de mora si aplica -->
                        <div class="mora-alert hidden" id="moraAlert">
                            <div class="alert-content">
                                <span class="alert-icon">‚ö†Ô∏è</span>
                                <div>
                                    <strong>Factura con Mora</strong>
                                    <p id="moraDetails">Esta factura tiene mora acumulada.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Datos del pago -->
                    <div class="payment-details hidden" id="paymentDetails">
                        <h4>üí≥ Datos del Pago</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="montoPago">Monto del Pago *</label>
                                <input type="number" id="montoPago" name="montoPago" 
                                       step="0.01" min="0" required readonly>
                                <small class="form-help">Pago completo de la factura + mora</small>
                            </div>
                            <div class="form-group">
                                <label for="fechaPago">Fecha del Pago *</label>
                                <input type="date" id="fechaPago" name="fechaPago" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="metodoPago">M√©todo de Pago *</label>
                                <select id="metodoPago" name="metodoPago" required>
                                    <option value="">Seleccione m√©todo</option>
                                    <option value="efectivo">üíµ Efectivo</option>
                                    <option value="transferencia">üè¶ Transferencia Bancaria</option>
                                    <option value="deposito">üèß Dep√≥sito Bancario</option>
                                    <option value="cheque">üìÑ Cheque</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="referencia">Referencia/Comprobante</label>
                                <input type="text" id="referencia" name="referencia" 
                                       placeholder="No. de comprobante, cheque, etc.">
                            </div>
                        </div>

                        <!-- Campos adicionales para cheques -->
                        <div class="cheque-fields hidden" id="chequeFields">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="bancoCheque">Banco del Cheque *</label>
                                    <input type="text" id="bancoCheque" name="bancoCheque" 
                                           placeholder="Nombre del banco">
                                </div>
                                <div class="form-group">
                                    <label for="numeroCheque">N√∫mero del Cheque *</label>
                                    <input type="text" id="numeroCheque" name="numeroCheque" 
                                           placeholder="N√∫mero del cheque">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="observaciones">Observaciones</label>
                            <textarea id="observaciones" name="observaciones" rows="3" 
                                    placeholder="Comentarios adicionales sobre el pago..."></textarea>
                        </div>

                        <!-- Resumen del pago -->
                        <div class="payment-summary">
                            <h5>üìÑ Resumen del Pago</h5>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <span>Monto Original:</span>
                                    <span id="summaryOriginal">Q 0.00</span>
                                </div>
                                <div class="summary-item" id="summaryMoraItem">
                                    <span>Mora:</span>
                                    <span id="summaryMora">Q 0.00</span>
                                </div>
                                <div class="summary-item total">
                                    <span><strong>Total a Pagar:</strong></span>
                                    <span id="summaryTotal"><strong>Q 0.00</strong></span>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary">
                            üí∞ Registrar Pago y Generar DTE
                        </button>
                    </div>
                </form>
            </section>

            <!-- Secci√≥n de Facturas Pendientes -->
            <section class="pending-invoices-section">
                <h2 class="section-title">Facturas Pendientes</h2>
                
                <!-- Filtros mejorados -->
                <div class="filters-section">
                    <input type="text" id="searchPending" class="search-box" 
                           placeholder="üîç Buscar por cliente, factura o proyecto...">
                    
                    <div class="filter-row">
                        <select id="projectFilter" title="Filtrar por proyecto">
                            <option value="">Todos los proyectos</option>
                            <option value="san-miguel">San Miguel</option>
                            <option value="santa-clara-1">Santa Clara Fase 1</option>
                            <option value="santa-clara-2">Santa Clara Fase 2</option>
                            <option value="cabanas-1">Caba√±as Fase 1</option>
                            <option value="cabanas-2">Caba√±as Fase 2</option>
                        </select>
                        
                        <select id="statusFilter" title="Filtrar por estado">
                            <option value="">Todos los estados</option>
                            <option value="pendiente">Pendientes</option>
                            <option value="vencida">Vencidas</option>
                            <option value="mora">Con Mora</option>
                        </select>
                        
                        <button type="button" id="refreshBtn" class="refresh-btn" title="Actualizar lista">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>

                <!-- Resumen de pendientes -->
                <div class="pending-summary">
                    <div class="summary-card">
                        <div class="summary-number" id="totalPendingCount">0</div>
                        <div class="summary-label">Facturas Pendientes</div>
                    </div>
                    <div class="summary-card warning">
                        <div class="summary-number" id="totalPendingAmount">Q 0.00</div>
                        <div class="summary-label">Monto Total Pendiente</div>
                    </div>
                    <div class="summary-card danger">
                        <div class="summary-number" id="overdueCount">0</div>
                        <div class="summary-label">Facturas Vencidas</div>
                    </div>
                    <div class="summary-card info">
                        <div class="summary-number" id="totalMoraAmount">Q 0.00</div>
                        <div class="summary-label">Total en Mora</div>
                    </div>
                </div>

                <!-- Tabla de facturas pendientes con paginaci√≥n -->
                <div class="table-container">
                    <div class="table-wrapper">
                        <table class="pending-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>No. Factura</th>
                                    <th>Fecha Emisi√≥n</th>
                                    <th>D√≠as Vencida</th>
                                    <th>Monto Original</th>
                                    <th>Mora</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="pendingTableBody">
                                <tr>
                                    <td colspan="9" class="loading-cell">
                                        <div class="loading-spinner">
                                            <div class="spinner"></div>
                                            Cargando facturas pendientes...
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Controles de paginaci√≥n -->
                    <div class="pagination-container hidden" id="paginationContainer">
                        <div class="pagination-info">
                            <span id="paginationInfo">Mostrando 0 de 0 registros</span>
                        </div>
                        
                        <div class="pagination-controls">
                            <div class="page-size-selector">
                                <label>Mostrar:</label>
                                <select id="pageSizeSelect" title="Seleccionar cantidad por p√°gina">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                                <span>por p√°gina</span>
                            </div>
                            
                            <div>
                                <button class="pagination-btn" id="firstPageBtn" title="Primera p√°gina">‚èÆÔ∏è</button>
                                <button class="pagination-btn" id="prevPageBtn" title="P√°gina anterior">‚¨ÖÔ∏è</button>
                                
                                <span id="pageNumbers">
                                    <!-- Se llenar√°n din√°micamente -->
                                </span>
                                
                                <button class="pagination-btn" id="nextPageBtn" title="P√°gina siguiente">‚û°Ô∏è</button>
                                <button class="pagination-btn" id="lastPageBtn" title="√öltima p√°gina">‚è≠Ô∏è</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n de Historial de Pagos -->
            <section class="payment-history-section">
                <h2 class="section-title">Historial de Pagos Recientes</h2>
                
                <div class="filters-section">
                    <input type="text" id="searchPayments" class="search-box" 
                           placeholder="üîç Buscar en historial de pagos...">
                    
                    <div class="filter-row">
                        <select id="methodFilter" title="Filtrar por m√©todo de pago">
                            <option value="">Todos los m√©todos</option>
                            <option value="efectivo">Efectivo</option>
                            <option value="transferencia">Transferencia</option>
                            <option value="deposito">Dep√≥sito</option>
                            <option value="cheque">Cheque</option>
                        </select>
                        
                        <input type="date" id="dateFromFilter" title="Desde fecha">
                        <input type="date" id="dateToFilter" title="Hasta fecha">
                    </div>
                </div>

                <div class="table-wrapper">
                    <table class="payments-table">
                        <thead>
                            <tr>
                                <th>Fecha Pago</th>
                                <th>Cliente</th>
                                <th>No. Factura</th>
                                <th>Monto Pagado</th>
                                <th>M√©todo</th>
                                <th>Referencia</th>
                                <th>Estado FEL</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                            <tr>
                                <td colspan="8" class="loading-cell">
                                    <div class="loading-spinner">
                                        üîÑ Cargando historial de pagos...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal para ver detalles del pago -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí∞ Detalles del Pago</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="paymentDetails-modal">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n de pago -->
    <div id="confirmPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úÖ Confirmar Pago</h3>
                <span class="close-confirm">&times;</span>
            </div>
            <div class="modal-body">
                <div class="confirm-content">
                    <div class="confirm-icon">üí∞</div>
                    <h4>¬øConfirmar registro de pago?</h4>
                    <div id="confirmPaymentDetails">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                    <div class="fel-notice">
                        <p><strong>‚ö†Ô∏è Importante:</strong> Al confirmar este pago se generar√° autom√°ticamente el Documento Tributario Electr√≥nico (DTE) ante la SAT seg√∫n la legislaci√≥n guatemalteca.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeConfirmPaymentModal()">Cancelar</button>
                <button type="button" class="btn-primary" onclick="confirmPaymentRegistration()">‚úÖ Confirmar y Generar DTE</button>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODAL: GESTIONAR FACTURAS DEL CLIENTE -->
    <!-- ========================================= -->
    <div id="manageInvoicesModal" class="modal">
        <div class="modal-content modal-xlarge">
            <div class="modal-header">
                <h3>üóëÔ∏è Gestionar Facturas del Cliente</h3>
                <span class="close-modal" onclick="closeManageInvoicesModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- B√∫squeda de Cliente -->
                <div class="manage-search-section">
                    <label for="manageClientSearch">Buscar Cliente:</label>
                    <input
                        type="text"
                        id="manageClientSearch"
                        class="search-box"
                        placeholder="üîç Buscar por nombre, DPI, No. de factura, contador..."
                        oninput="searchClientForManage()"
                    >
                </div>

                <!-- Resultados de B√∫squeda -->
                <div id="manageSearchResults" class="manage-search-results hidden">
                    <!-- Se llenar√° din√°micamente -->
                </div>

                <!-- Informaci√≥n del Cliente Seleccionado -->
                <div id="manageClientInfo" class="manage-client-info hidden">
                    <h4>Cliente Seleccionado:</h4>
                    <div id="manageClientDetails"></div>
                </div>

                <!-- Tabla de Facturas -->
                <div id="manageInvoicesTable" class="manage-invoices-table hidden">
                    <h4>Facturas del Cliente:</h4>
                    <div class="table-actions">
                        <label class="checkbox-label">
                            <input type="checkbox" id="selectAllInvoices" onchange="toggleSelectAll()">
                            <span>Seleccionar Todas</span>
                        </label>
                        <span id="selectedCount" class="selected-count">0 seleccionadas</span>
                    </div>

                    <div class="table-container">
                        <table id="invoicesTable">
                            <thead>
                                <tr>
                                    <th class="checkbox-column"></th>
                                    <th>No. Factura</th>
                                    <th>Fecha Emisi√≥n</th>
                                    <th>Fecha Vencimiento</th>
                                    <th>Estado</th>
                                    <th>Monto</th>
                                    <th>Mora</th>
                                    <th>Tipo</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTableBody">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>

                    <div class="manage-actions">
                        <button
                            type="button"
                            id="btnDeleteSelected"
                            class="btn-danger"
                            onclick="confirmDeleteInvoices()"
                            disabled
                        >
                            üóëÔ∏è Eliminar Seleccionadas (<span id="deleteCount">0</span>)
                        </button>
                    </div>
                </div>

                <!-- Mensaje cuando no hay resultados -->
                <div id="manageNoResults" class="manage-no-results hidden">
                    <p>üîç Busca un cliente para gestionar sus facturas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODAL: CONFIRMACI√ìN DE ELIMINACI√ìN (1ra) -->
    <!-- ========================================= -->
    <div id="deleteConfirmModal1" class="modal">
        <div class="modal-content">
            <div class="modal-header modal-header-warning">
                <h3>‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
                <span class="close-modal" onclick="closeDeleteConfirmModal1()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="warning-box">
                    <p><strong>¬øEst√° seguro que desea eliminar las facturas seleccionadas?</strong></p>
                    <div id="deleteConfirmDetails"></div>
                    <p class="warning-text">Esta acci√≥n no se puede deshacer.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeDeleteConfirmModal1()">Cancelar</button>
                <button type="button" class="btn-danger" onclick="showDeleteConfirmModal2()">S√≠, continuar</button>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODAL: CONFIRMACI√ìN DE ELIMINACI√ìN (2da) -->
    <!-- ========================================= -->
    <div id="deleteConfirmModal2" class="modal">
        <div class="modal-content">
            <div class="modal-header modal-header-danger">
                <h3>üîê Confirmaci√≥n Final</h3>
                <span class="close-modal" onclick="closeDeleteConfirmModal2()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="danger-box">
                    <p><strong>CONFIRMACI√ìN FINAL DE ELIMINACI√ìN</strong></p>
                    <p>Est√° a punto de eliminar permanentemente <strong><span id="finalDeleteCount">0</span> facturas</strong>.</p>

                    <div class="form-group">
                        <label for="deletePassword">Contrase√±a Administrativa *</label>
                        <input
                            type="password"
                            id="deletePassword"
                            placeholder="Ingrese la contrase√±a administrativa"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="deleteMotivo">Motivo de la Eliminaci√≥n *</label>
                        <textarea
                            id="deleteMotivo"
                            rows="3"
                            placeholder="Ej: Facturas de prueba, datos err√≥neos, etc."
                            required
                        ></textarea>
                    </div>

                    <p class="danger-text">‚ö†Ô∏è Esta acci√≥n quedar√° registrada en el sistema de auditor√≠a.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeDeleteConfirmModal2()">Cancelar</button>
                <button type="button" class="btn-danger" onclick="executeDeleteInvoices()">‚úÖ Confirmar Eliminaci√≥n</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/auth.js"></script>
    <script src="../js/pageProtection.js"></script>
    <script src="../js/pagos.js"></script>
    <script src="../js/factura.admin.js"></script>
</body>
</html>