üìã INSTRUCTIONS FOR CLAUDE CODE - Payment Ticket PDF Generation
Sistema de Agua LOTI - Huehuetenango, Guatemala

üéØ OBJECTIVE
Create a thermal ticket-style PDF generator (80mm width) for payment receipts. This will be used for testing purposes before implementing the FEL (SAT Guatemala) integration with Infile.
IMPORTANT: All variable names, function names, comments, and user-facing strings must be in SPANISH. Only reserved keywords should be in English.

üìä PHASE 1: SYSTEM ANALYSIS (MANDATORY FIRST STEP)
Before writing any code, you MUST perform a comprehensive analysis of the existing system:
1.1 Project Structure Analysis
bash# Execute these commands to understand the project structure:
cd /path/to/agua-loti
ls -R backend/
ls -R frontend/
Document:

Folder structure (controllers, models, services, routes)
Naming conventions used in existing files
How modules are organized

1.2 Existing Models Analysis
READ and ANALYZE these files:

backend/models/pago.model.js - Payment model
backend/models/factura.model.js - Invoice model
backend/models/cliente.model.js - Client model
backend/controllers/pago.controller.js - Payment controller

Document:

Field names in Spanish (e.g., nombres, apellidos, montoPagado)
Data structure of payment objects
How models relate to each other (populate patterns)
Existing validation patterns

1.3 API Endpoints Analysis
Identify:

Current payment endpoints (POST, GET, PUT)
Response format pattern ({ success: boolean, data: any, message: string })
Authentication middleware usage
Error handling patterns

1.4 Dependencies Analysis
Check package.json for:

Already installed PDF libraries (if any)
QR code libraries (if any)
File system libraries being used

If NOT installed, you will need to install:

pdfkit (for PDF generation)
qrcode (for QR code generation)

1.5 Configuration Analysis
Check:

backend/config/ or .env file for existing configurations
How file paths are managed
Where uploads/outputs are stored

üìã PHASE 2: TECHNICAL SPECIFICATIONS
2.1 PDF Ticket Specifications
Format:

Width: 80mm (thermal ticket style)
Paper: Continuous (auto-height based on content)
Margins: 5mm on each side
Font: Monospace (Courier) for better readability

Sections (in order):

HEADER

Business name: "SISTEMA DE AGUA LOTI"
Location: "Huehuetenango, Guatemala"
Placeholder for logo (leave space: 60mm x 30mm centered)
Horizontal separator line

TICKET INFO

Label: "RECIBO DE PAGO" (centered, bold)
N√∫mero de Pago: [numeroPago]
Fecha de Emisi√≥n: [formatted date]
Horizontal separator line

CLIENT DATA

Label: "DATOS DEL CLIENTE" (bold)
Cliente: [nombres apellidos]
DPI: [dpi]
Contador: [contador]
Lote: [lote]
Proyecto: [proyecto formatted name]

INVOICE DATA

Label: "FACTURA PAGADA" (bold)
No. Factura: [numeroFactura]
Fecha Emisi√≥n: [fechaEmision]
Fecha Vencimiento: [fechaVencimiento]
Per√≠odo: [periodoInicio] - [periodoFin]

PAYMENT BREAKDOWN

Label: "DETALLE DEL PAGO" (bold)
Subtotal Factura: Q [montoOriginal] (right-aligned)
Mora (si aplica): Q [montoMora] (right-aligned)
Reconexi√≥n (si aplica): Q [montoReconexion] (right-aligned)
Horizontal separator line (double)
TOTAL PAGADO: Q [montoPagado] (bold, larger font, right-aligned)

PAYMENT METHOD

Label: "M√âTODO DE PAGO" (bold)
M√©todo: [metodoPago capitalized]
Referencia: [referenciaPago] (if exists)
Banco: [bancoCheque] (if cheque)
No. Cheque: [numeroCheque] (if cheque)

QR CODE

Label: "C√ìDIGO DE VERIFICACI√ìN" (centered)
QR Code (30mm x 30mm, centered)
QR contains JSON string:

json     {
       "numeroPago": "string",
       "fecha": "ISO date",
       "monto": number,
       "hash": "SHA256 hash"
     }

```

8. **FOOTER**
   - Horizontal separator line
   - "Gracias por su pago" (centered)
   - Fecha y hora de impresi√≥n: [current timestamp]
   - "Sistema de Agua LOTI v2.0" (centered, small)

### 2.2 File Naming Convention
```

PAGO-[NUMERO_PAGO]-[YYYYMMDD].pdf

Example: PAGO-PAG-202510-0001-20251024.pdf

```

### 2.3 Storage Location
```

/backend/uploads/tickets/[YEAR]/[MONTH]/[filename].pdf

Example: /backend/uploads/tickets/2025/10/PAGO-PAG-202510-0001-20251024.pdf

üîß PHASE 3: IMPLEMENTATION INSTRUCTIONS
3.1 Create New Service File
Location: backend/services/ticketPago.service.js
Structure:
javascript/**

* Servicio para generar tickets de pago en PDF
* Genera tickets t√©rmicos de 80mm de ancho
 */

// Imports
const PDFDocument = require('pdfkit');
const QRCode = require('qrcode');
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');

// Models
const Pago = require('../models/pago.model');
const Factura = require('../models/factura.model');
const Cliente = require('../models/cliente.model');

class TicketPagoService {
  // Constructor
  constructor() {
    this.anchoTicket = 226.77; // 80mm en puntos
    this.margen = 14.17; // 5mm en puntos
    // ... more configuration
  }

  /**

* Genera un ticket PDF para un pago espec√≠fico
* @param {string} pagoId - ID del pago en MongoDB
* @returns {Promise<{exitoso: boolean, rutaArchivo: string, mensaje: string}>}
   */
  async generarTicketPago(pagoId) {
    // Implementation here
  }

  /**

* Genera el c√≥digo QR de verificaci√≥n
* @param {Object} datosQR - Datos para el QR
* @returns {Promise<Buffer>}
   */
  async generarCodigoQR(datosQR) {
    // Implementation here
  }

  /**

* Crea el hash de verificaci√≥n
* @param {Object} datosPago - Datos del pago
* @returns {string} Hash SHA256
   */
  crearHashVerificacion(datosPago) {
    // Implementation here
  }

  /**

* Asegura que el directorio de tickets existe
* @param {number} anio - A√±o
* @param {number} mes - Mes
* @returns {string} Ruta del directorio
   */
  asegurarDirectorioTickets(anio, mes) {
    // Implementation here
  }

  /**

* Formatea el nombre del proyecto
* @param {string} proyectoKey - Clave del proyecto
* @returns {string} Nombre formateado
   */
  formatearNombreProyecto(proyectoKey) {
    // Implementation here
  }
}

module.exports = new TicketPagoService();
3.2 Implementation Steps
Step 1: Install required dependencies
bashnpm install pdfkit qrcode --save
Step 2: Implement generarTicketPago() method

Fetch payment data with all populated fields:

javascript  const pago = await Pago.findById(pagoId)
    .populate('clienteId', 'nombres apellidos dpi contador lote proyecto')
    .populate('facturaId', 'numeroFactura fechaEmision fechaVencimiento periodoInicio periodoFin');

Validate data exists
Create PDF document with pdfkit
Add all sections in order (header ‚Üí footer)
Save to file system
Return success response

Step 3: Implement generarCodigoQR() method

Create JSON with payment verification data
Generate QR code as buffer
Return buffer to embed in PDF

Step 4: Implement crearHashVerificacion() method

Concatenate: numeroPago + fecha + monto + secret
Use crypto.createHash('sha256')
Return hash string

Step 5: Implement asegurarDirectorioTickets() method

Check if directory exists: /backend/uploads/tickets/[year]/[month]/
If not, create recursively using fs.mkdirSync(path, { recursive: true })
Return full directory path

Step 6: Implement formatearNombreProyecto() method

Map project keys to display names:

javascript  const proyectos = {
    'san-miguel': 'San Miguel',
    'santa-clara-1': 'Santa Clara Fase 1',
    'santa-clara-2': 'Santa Clara Fase 2',
    'cabanas-1': 'Caba√±as Fase 1',
    'cabanas-2': 'Caba√±as Fase 2'
  };
3.3 Add Controller Method
Location: backend/controllers/pago.controller.js
Add this new method:
javascript/**

* Generar ticket PDF para un pago
 */
exports.generarTicketPago = async (req, res) => {
  try {
    const { id } = req.params;

    // Llamar al servicio
    const resultado = await ticketPagoService.generarTicketPago(id);

    if (resultado.exitoso) {
      // Enviar el archivo PDF
      res.download(resultado.rutaArchivo, resultado.nombreArchivo, (err) => {
        if (err) {
          console.error('Error al enviar ticket:', err);
          res.status(500).json({
            success: false,
            message: 'Error al descargar el ticket'
          });
        }
      });
    } else {
      res.status(400).json({
        success: false,
        message: resultado.mensaje
      });
    }

  } catch (error) {
    console.error('Error al generar ticket:', error);
    res.status(500).json({
      success: false,
      message: 'Error interno del servidor',
      error: error.message
    });
  }
};
3.4 Add Route
Location: backend/routes/pago.routes.js
Add this route:
javascript// Generar ticket de pago (PDF)
router.get('/:id/ticket', authMiddleware, pagoController.generarTicketPago);
3.5 Update Payment Creation
Location: backend/controllers/pago.controller.js
In the createPago method, after successfully creating the payment:
javascript// ... existing payment creation code ...

await session.commitTransaction();

// Generar ticket autom√°ticamente
try {
  const ticketResultado = await ticketPagoService.generarTicketPago(pago._id);
  
  if (ticketResultado.exitoso) {
    console.log('‚úÖ Ticket generado:', ticketResultado.nombreArchivo);
  } else {
    console.warn('‚ö†Ô∏è No se pudo generar el ticket:', ticketResultado.mensaje);
  }
} catch (ticketError) {
  console.error('‚ùå Error al generar ticket autom√°ticamente:', ticketError);
  // No fallar la creaci√≥n del pago si el ticket falla
}

// ... rest of response ...

üß™ PHASE 4: TESTING INSTRUCTIONS
4.1 Unit Tests
Create: backend/tests/ticketPago.service.test.js
Test cases:

Should generate QR code successfully
Should create verification hash correctly
Should format project names properly
Should create directory structure
Should generate complete PDF ticket

4.2 Integration Tests
Test workflow:

Create a test payment via API
Verify ticket PDF is generated automatically
Check file exists in correct directory
Verify PDF contains all required data
Test manual ticket regeneration endpoint

4.3 Manual Testing Checklist

 Install dependencies successfully
 Service file created with all methods
 Controller method added
 Route added and working
 Create a payment and verify PDF generates
 Open PDF and verify all sections present
 Verify QR code scans correctly
 Verify data accuracy in PDF
 Test with different payment methods (efectivo, cheque, transferencia)
 Test with mora and reconexi√≥n amounts
 Test file naming convention
 Test directory structure creation

üìù PHASE 5: DOCUMENTATION
5.1 Create README
Location: backend/services/README_TICKETS.md
Content:

How the ticket service works
Configuration options
How to regenerate tickets
File structure explanation
QR code data format

5.2 Add JSDoc Comments
All functions must have complete JSDoc:
javascript/**

* Genera un ticket PDF de pago
* @async
* @param {string} pagoId - ID del pago en MongoDB
* @returns {Promise<Object>} Resultado de la operaci√≥n
* @returns {boolean} resultado.exitoso - Si la operaci√≥n fue exitosa
* @returns {string} resultado.rutaArchivo - Ruta completa del archivo PDF
* @returns {string} resultado.nombreArchivo - Nombre del archivo generado
  @returns {string} resultado.mensaje - Mensaje descriptivo
  @throws {Error} Si el pago no existe o hay error al generar el PDF
  @example
  const resultado = await ticketPagoService.generarTicketPago('67123abc...');
 */

‚ö†Ô∏è IMPORTANT NOTES
Security Considerations:

Path traversal protection: Validate file paths
Authentication: Require valid JWT token
Authorization: Verify user can access that payment
File size limits: Implement max file size
Rate limiting: Prevent abuse of PDF generation

Performance Considerations:

Async operations: Use async/await properly
Error handling: Don't crash server on PDF errors
Memory management: Stream PDFs for large files
Cleanup: Consider automatic old file deletion

Spanish Naming Convention Examples:
javascript// ‚úÖ CORRECT
const nombreCliente = 'Juan Garc√≠a';
const montoPagado = 150.50;
function calcularTotalConMora(subtotal, mora) { }
// Calcular el total del pago

// ‚ùå INCORRECT
const clientName = 'Juan Garc√≠a';
const paidAmount = 150.50;
function calculateTotalWithLateFee(subtotal, lateFee) { }

üéØ DELIVERABLES CHECKLIST
Before considering this task complete, verify:

 backend/services/ticketPago.service.js created and working
 Controller method added to pago.controller.js
 Route added to pago.routes.js
 Automatic ticket generation on payment creation
 Manual ticket regeneration endpoint working
 All Spanish naming conventions followed
 All JSDoc comments in Spanish
 README documentation created
 Tests passing (if implemented)
 Sample ticket generated and verified
 QR code working correctly
 File structure created properly
 No console errors during generation
 Git commit with message: "feat: agregar generaci√≥n de tickets PDF para pagos"

üìû SUPPORT INFORMATION
If you encounter issues:

Check the existing codebase patterns first
Verify all dependencies are installed
Check file permissions for uploads directory
Verify MongoDB connection is working
Test with a valid payment ID from database

END OF INSTRUCTIONS

Project: Sistema de Agua LOTI
Version: 2.0
Date: October 24, 2025
Instructions prepared for: Claude Code (Anthropic)Reintentar
